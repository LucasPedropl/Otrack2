
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- FUNÇÕES AUXILIARES ---

    function isAuthenticated() {
      // Nota: request.auth só é preenchido em logins via Google ou Firebase Auth direto.
      // Usuários "Gerenciados" (E-mail/Senha manual) não preenchem este campo.
      return request.auth != null;
    }

    // Verifica permissão no perfil (Apenas para usuários autenticados via Firebase)
    function hasPermission(requiredPermission) {
      let userData = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      let profile = get(/databases/$(database)/documents/access_profiles/$(userData.profileId)).data;
      return 'admin:full' in profile.permissions || requiredPermission in profile.permissions;
    }

    // --- REGRAS POR COLEÇÃO ---

    match /users/{userId} {
      // Permite leitura pública para login e exibição de perfis, 
      // mas escrita apenas para administradores autenticados.
      allow read: if true; 
      allow write: if isAuthenticated() && hasPermission('acesso_usuarios:create');
      allow update: if isAuthenticated() && (request.auth.uid == userId || hasPermission('acesso_usuarios:create')); 
    }

    match /access_profiles/{profileId} {
      // Leitura pública para que o frontend carregue as permissões do usuário logado manual
      allow read: if true; 
      allow write: if isAuthenticated() && hasPermission('acesso_perfis:create');
      allow delete: if isAuthenticated() && hasPermission('acesso_perfis:delete');
    }

    match /inventory/{itemId} {
      allow read: if true; 
      allow create, update: if isAuthenticated() && hasPermission('orcamento_insumos:create');
      allow delete: if isAuthenticated() && hasPermission('orcamento_insumos:delete');
    }

    match /measurement_units/{unitId} {
      allow read: if true;
      allow write: if isAuthenticated() && hasPermission('orcamento_unidades:create');
      allow delete: if isAuthenticated() && hasPermission('orcamento_unidades:delete');
    }

    match /item_categories/{catId} {
      allow read: if true;
      allow write: if isAuthenticated() && hasPermission('orcamento_categorias:create');
      allow delete: if isAuthenticated() && hasPermission('orcamento_categorias:delete');
    }

    match /construction_sites/{siteId} {
      // Permite que qualquer um veja a lista de obras, 
      // mas o filtro de qual obra aparece é feito no frontend pelo PermissionsContext
      allow read: if true; 
      allow create, update: if isAuthenticated() && hasPermission('obras:create');
      allow delete: if isAuthenticated() && hasPermission('obras:delete');

      match /inventory/{siteItemId} {
        allow read: if true;
        allow write: if isAuthenticated() && hasPermission('obras:create');
        
        match /movements/{movId} {
           allow read: if true;
           allow create: if true; // Permite registrar movimentação (será validado no service)
        }
      }
    }
  }
}
